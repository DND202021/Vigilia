# Vigilia MQTT Broker Configuration
# Uses mosquitto-go-auth plugin with HTTP backend for database-backed authentication

# Persistence
persistence true
persistence_location /mosquitto/data/
persistent_client_expiration 2h

# Logging
log_dest file /mosquitto/log/mosquitto.log
log_type error
log_type warning
log_type notice
log_type information
connection_messages true

# Message queue limits (prevent memory bloat from offline devices)
max_queued_messages 1000

# Authentication plugin (mosquitto-go-auth with HTTP backend)
auth_plugin /mosquitto/go-auth.so
auth_opt_log_level info
auth_opt_backends http
auth_opt_cache_type go-cache
auth_opt_cache_reset true
auth_opt_auth_cache_seconds 30
auth_opt_acl_cache_seconds 30
auth_opt_auth_jitter_seconds 3
auth_opt_acl_jitter_seconds 3

# HTTP backend endpoints (FastAPI backend service)
auth_opt_http_host backend
auth_opt_http_port 8000
auth_opt_http_getuser_uri /api/v1/mqtt/auth
auth_opt_http_superuser_uri /api/v1/mqtt/superuser
auth_opt_http_aclcheck_uri /api/v1/mqtt/acl
auth_opt_http_with_tls false
auth_opt_http_verify_peer false
auth_opt_http_response_mode status
auth_opt_http_params_mode form

# Listener configuration (per-listener settings enabled)
per_listener_settings true

# Internal health check listener (localhost only, anonymous allowed)
listener 1883 127.0.0.1
allow_anonymous true

# External TLS listener (all auth via HTTP plugin)
listener 8883
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key
require_certificate false
allow_anonymous false
